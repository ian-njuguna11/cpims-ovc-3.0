{% extends 'base.html' %}
{% load app_filters %}
{% load static %}
{% block page_title %} Bidirectional Form {% endblock %}
{% block style_code %}
    <link href="{% static 'plugins/parsley/src/parsley.css' %}" rel="stylesheet"/>
    <link href="{% static 'plugins/bootstrap-datepicker/css/datepicker3.css' %}" rel="stylesheet"/>
    <link href="{% static 'plugins/bootstrap-wizard/css/bwizard.min.css' %}" rel="stylesheet"/>
    <link href="{% static 'plugins/bootstrap-multiselect/dist/css/bootstrap-multiselect.css' %}" rel="stylesheet">
    <link href="{% static 'css/jquery.tagit.css' %}" rel="stylesheet">
    <link href="{% static 'css/bootstrap-table.min.css' %}" rel="stylesheet"/>
    <style type="text/css">
        .dialog_paragraph {
            color: #f00;
        }

        .table_data {
            display: none;
        }

        .container {
            width: 100%;
            overflow-x: auto;
        }

        .td_style {
            /* color: #000000;*/
            color: #0057e7;
        }
    </style>
{% endblock %}

{% block javascript_code %}
{% endblock javascript_code %}

{% block primary %}

    <!-- begin breadcrumb -->
    <ol class="breadcrumb pull-right">
        <li><a href="#">Home</a></li>
        <li class="active">Forms</li>
    </ol>
    <!-- end breadcrumb -->

    <!-- begin page-header -->

    {% for data in init_data %}

        <h1 class="page-header">Forms: <small>Bidirectional Referral Form
            <b>{{ data.first_name }} {{ data.surname }} | {{ data.sex_id|gen_value:vals }} |
                {% if data.date_of_birth|gen_age == 0 %}
                    UNDER 1 YEAR
                {% else %}
                    {{ data.date_of_birth|gen_age }} YRS
                {% endif %}</b></small></h1>

    {% endfor %}
    <!-- end page-header -->

    <div id="messages" class="alert alert-danger fade in" style="display: none;" tabindex="1">
        <span class="close" data-dismiss="alert">Ã—</span>
        <i class="fa fa-info fa-2x pull-left"></i>
        <span class="invalid-form-message" id="invalid-form-message"></span>
    </div>

    <!-- begin row -->
    <div id='case_details' class="row">

    <!-- begin col-12 -->
    <div class="col-md-12">
        <!-- begin panel -->
        <div class="panel panel-inverse">
            <div class="panel-heading">
                <div class="panel-heading-btn">
                    <a href="#" class="btn btn-xs btn-icon btn-circle btn-warning" data-click="panel-expand"><i
                            class="fa fa-minus"></i></a>
                    <a href="#" class="btn btn-xs btn-icon btn-circle btn-default" data-click="panel-collapse"><i
                            class="fa fa-times"></i></a>
                </div>
                <h4 class="panel-title"> REFERRAL FORM </h4>
            </div>
            <div class="panel-body">
                <table width="100%" class="table">
                    <tbody>
                    <tr>
                        <td class="field">Name of Person Being Referred: {{ all_domain_choices.refferal_domain }}</td>
                        <td class="field">Organization referred to: {{ all_domain_choices.refferal_service }}</td>
                    </tr>
                    </tbody>
                </table>
                <form method="post" action=".">
                    {% csrf_token %}
                    <div id="">


                        <!-- begin wizard step-1 -->
                        <div class="wizard-step-1">
                            <fieldset>
                                <div id="error_assessment"></div>
                                <div style="overflow-x: auto; min-height: 300px;">
                                    <!-- begin col-6 -->
                                    <table id="assessment_manager_table" class="table" style="min-height: 300px;">
                                        <thead>
                                        <tr id="id_inputHeaders1">
                                            <td width="5%"></td>
                                            <th width="15%"><h6><b>Domain<span class="asteriskField">*</h6></b></th>
                                            <th width="20%"><h6><b>Core Services<span class="asteriskField">*</b></h6>
                                            </th>
                                            <th width="25%"><h6><b>Referral Date<span class="asteriskField">*</b></h6>
                                            </th>
                                            <th width="5%"><h6><b>Actions</b></h6></th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr id="id_inputElements1">
                                            <td></td>
                                            <td width="15%">
                                                {{ form.BIREFERRAL_DOMAIN }}
                                                <div id="BIREFERRAL_DOMAIN" style="display:none;">
                                                    <small><p class="dialog_paragraph">This value is required</p></span>
                                                    </small><span>
                                                </div>
                                            </td>
                                            <td width="20%">
                                                {{ form.BIREFERRAL_SERVICES }}
                                                <div id="BIREFERRAL_SERVICES" style="display:none;">
                                                    <small><p class="dialog_paragraph">This value is required</p></span>
                                                    </small><span>
                                                </div>
                                            </td>
                                            <td width="15%">
                                                {{ form.REFERRAL_DATE }}
                                                <h6><span id="REFERRAL_DATE"></span></h6>
                                                <!-- <input id='holmis_assessment_coreservice_status' type='hidden'> -->
                                                <div id="olmis_assessment_coreservice_status_errormsg"
                                                     style="display:none;">
                                                    <small><p class="dialog_paragraph">This value is required</p></span>
                                                    </small><span>
                                                </div>
                                            </td>
                                            <td width="5%">
                                                <h6><b>
                                                    <button type="button" class="btn btn-sm btn-inverse m-r-5"
                                                            onClick="AddRow()">
                                                        <i class="fa fa-plus"></i> Add
                                                    </button>
                                                </b></h6>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td></td>
                                            <td>
                                                <div class="form-group">
                                                    <label class="control-label">Date Assessment
                                                        Recorded<span
                                                                class="asteriskField">*</label>
                                                    <div class="">
                                                        {{ form.REFERRAL_END_DATE }}
                                                        <div id="date_errormsg0" style="display:none;">
                                                            <small><p class="dialog_paragraph">This value is
                                                                required</p></small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <!-- end col-6 -->
                            </fieldset>

                        </div>


                    </div>
                    <!-- end wizard step-1 -->
                    <!-- end row -->

                    <!-- end col-12 -->
                    <div class="panel-body panel-form">
                        <div class="form-group">
                            <label class="control-label col-md-4 col-sm-4"></label>
                            <div class="col-md-6 col-sm-6">
                                <button id="mysubmit-f1a-0" class="btn btn-primary" type="submit`">Submit
                                    Assessment
                                </button>
                                <!--TODO  pass in the url and id for cancel-->
                                <a href="#" onClick="resetForm1A(1)" class="btn btn-white">Cancel</a>
                            </div>
                        </div>
                    </div>
                </form>   <!-- end row -->
            </div>
        </div>

        <!-- Bidirectional events -->

    <!-- begin row -->
<div class="row">
    <!-- begin col-12 -->
    <div class="col-md-12">
        <!-- begin panel -->
        <div class="panel panel-info">
            <div class="panel-heading">
                <div class="panel-heading-btn">
                    <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-default" data-click="panel-expand"><i class="fa fa-expand"></i></a>
                    <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-warning" data-click="panel-collapse"><i class="fa fa-minus"></i></a>
                </div>
                <h4 class="panel-title"><b>REFERRAL FORM Events List </b></h4>
            </div>
        </div>
      

            <div class="panel-body">
                <div  class="panel panel-inverse">
                    <div id="case-events"  class="table-responsive">
                        <table id="f1a_events_data_table" class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th>Domain Type</th>
                                    <th>Core Services</th>
                                    <th>Referral Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% if obj_all %}
                                {% for one_object in obj_all %}
                                    <tr>
                                        <td>{{ one_object.refferal_domain }}</td>
                                        <td>{{ one_object.refferal_service }}</td>
                                        <td>{{ one_object.refferal_date }}</td>
                                        <td><a href="{% url 'delete_bireferral' one_object.refferal_id %}">
                                            <button type="button" class="btn btn-sm btn-danger m-r-5"><i
                                                    class="fa fa-trash"></i>&nbsp;Delete
                                            </button>
                                        </a></td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <div>
                                    <h3>No data available</h3>
                                </div>
                            {% endif %}
                            </tbody>
                        </table>
                    </div>
                    <br><br>
                </div>
            </div>

        </div>
        <!-- end panel -->
    </div>
    <!-- end col-12 -->
</div>
<!-- end row -->

{% endblock %}

{% block lazy_javascript_code %}
    <script src="{% static 'plugins/parsley/dist/parsley.js' %}"></script>
    <script src="{% static 'plugins/bootstrap-wizard/js/bwizard.js' %}"></script>
    <script src="{% static 'plugins/bootstrap-multiselect/dist/js/bootstrap-multiselect.js' %}"></script>
    <script src="{% static 'js/apps.js' %}"></script>
    <script src="{% static 'js/form-wizards.js' %}"></script>
    <script src="{% static 'js/tag-it.js' %}"></script>
    <script src="{% static 'js/bootstrap-table.min.js' %}"></script>
    <script src="{% static 'js/bootstrap-table-locale-all.min.js' %}"></script>
    <script>
        jQuery(document).ready(function () {

            $("select[name='BIREFERRAL_DOMAIN']").change(
                () => {
                    const bireferral_domain = $("select[name='BIREFERRAL_DOMAIN']").val()
                    {#const bireferral_health = $("select[name='HEALTH_DOMAIN']").val()#}
                    {#const bireferral_stable = $("select[name='STABLE_DOMAIN']").val()#}

                    {# Empty Services Drop down#}
                    $("select[name='BIREFERRAL_SERVICES']").find('option')
                        .remove()
                        .end()


                    switch (bireferral_domain) {
                        case '1':

                            $("select[name='BIREFERRAL_SERVICES']").append(
                                ` <option>Health insurance cover</option>
                                          <option>secticide Treated Mosquito net (ITN)</option>
                                          <option>Enrollment to care and treatment</option>
                                          <option>Enhance Adherence Counselling</option>
                                          <option>Routine/ emergency healthcare</option>
                                          <option>Perinatal care including PMTCT</option>
                                          <option>HIV prevention support services_VMMC</option>
                                          <option>HIV prevention support services_PrEP</option>
                                          <option>HIV prevention support services_FM</option>
                                          <option> prevention support services_Condom</option>
                                          <option>STI treatment</option>
                                          <option>MUAC and Bipedal Oedema Assessment</option>
                                          <option>Nutrition support</option>
                                          <option>immunization</option>
                                          <option>HIV-related testing HTS</option>
                                          <option>HIV-related testing EID</option>
                                         `
                            );
                            break;
                        case 'DHES':
                            $("select[name='BIREFERRAL_SERVICES']")
                                .append(
                                    ` <option value="cash transfer OVC">cash transfer OVC</option>
                                  <option value="cash transfer Elderly">cash transfer Elderly</option>
                                  <option value="cash transfer Disability">cash transfer Disability</option>
                                  <option value="Safe shelter repair or construction">Safe shelter repair or construction</option>
                                  <option value="Routine/ emergency healthcare">Routine/ emergency healthcare</option>
                                  <option value="Perinatal care including PMTCT">Perinatal care including PMTCT</option>
                                 `
                                );
                            break;
                        case 'DPRO':
                            $("select[name='BIREFERRAL_SERVICES']").append(
                                ` <option>Post Violence Counseling </option>
                                  <option>Post Violence Medical care</option>
                                  <option>Post violence Legal Care</option>
                                  <option>Emergency shelter support</option>
                                  <option>Re-enrollment</option>
                                  <option>Bursary, tuition, school fees or fee exemption</option>
                                  <option>School uniform, books, or other materials</option>                                 
                                 `
                            );
                            break;
                        case 'DEDU':
                            $("select[name='BIREFERRAL_SERVICES']").append(
                                ` <option>Re-enrollment (i.e., for drop-outs or teen mothers) </option>
                                  <option>Bursary, tuition, school fees or fee exemption</option>
                                  <option>School uniform, books, or other materials</option>
                                  <option>Other </option>
                                                                  
                                 `
                            );
                            break;
                        default:
                            $("select[name='BIREFERRAL_SERVICES']").append(
                                {#                                {{ form.BIREFERRAL_SERVICES }}#}
                                '<option>No value</option>'
                            )
                    }

                }
            )

            //multi selects
            $('#BIREFERRAL_DEFAULT').multiselect({
                selectAllValue: 'multiselect-all',
                includeSelectAllOption: true,
                enableCaseInsensitiveFiltering: true,
                numberDisplayed: 1,
                maxHeight: 300,
                buttonWidth: '100%',
                buttonClass: 'btn btn-white'
            });

            // populate CSI Services Priority
            getServices(4, 'DHNU')
            getServices(4, 'DSHC')
            getServices(4, 'DPRO')
            getServices(4, 'DEDU')
            getServices(4, 'DPSS')
            getServices(4, 'DHES')

            $('html,body').scrollTop(0);
            FormWizardValidation.init();
        });
    </script>

    <script>
        $("#refferalDate").datepicker({format: 'yyyy-mm-dd'})
        $("#refferalEndDate").datepicker({format: 'yyyy-mm-dd'})
    </script>

    <script>
        function getServices(x, domain) {
            var multiselect_data = [];
            var data = new Array();
            var csrftoken = $.cookie('csrftoken');
            var index = 0;
            var multiselect_id = ''

            if (x == 1) {
                index = 2;
                multiselect_id = '#olmis_assessment_coreservice'
            }

            if (x == 2) {
                index = 3;
                multiselect_id = '#olmis_assessment_coreservice_status'
            }

            if (x == 3) {
                index = 1;
                multiselect_id = '#olmis_service'
            }

            if (x == 4) {
                index = 1;
                if (domain == 'DHNU') {
                    multiselect_id = '#olmis_priority_health';
                }
                if (domain == 'DSHC') {
                    multiselect_id = '#olmis_priority_shelter';
                }
                if (domain == 'DPRO') {
                    multiselect_id = '#olmis_priority_protection';
                }
                if (domain == 'DEDU') {
                    multiselect_id = '#olmis_priority_education';
                }
                if (domain == 'DPSS') {
                    multiselect_id = '#olmis_priority_pss';
                }
                if (domain == 'DHES') {
                    multiselect_id = '#olmis_priority_hes';
                }

            }

            if (x == 5) {
                index = 1;
                multiselect_id = '#olmis_priority_service'
            }

            var values = {
                'csrfmiddlewaretoken': csrftoken,
                'domain_id': domain,
                'index': index
            };

            // do an ajax_call
            $.ajax({
                url: '{% url 'manage_service_category' %}',
                dataType: 'json',
                method: 'POST',
                contentType: 'application/x-www-form-urlencoded',
                data: values,
                success: function (result) {
                    var status;
                    var item_sub_category_id;
                    var item_sub_category;
                    var multiselect_dict = {};

                    multiselect_data.push({label: 'Please Select', value: ''});

                    $.each(result, function (i, val) {
                        item_sub_category_id = val.item_sub_category_id;
                        item_sub_category = val.item_sub_category;
                        status = val.status;

                        var multiselect_dict = {label: item_sub_category, value: item_sub_category_id};
                        multiselect_data.push(multiselect_dict);
                    });

                    //add multi-select data
                    $('' + multiselect_id + '').multiselect('destroy');
                    $('' + multiselect_id + '').multiselect({
                        selectAllValue: 'multiselect-all',
                        enableCaseInsensitiveFiltering: true,
                        numberDisplayed: 1,
                        maxHeight: 300,
                        buttonWidth: '100%',
                        buttonClass: 'btn btn-white',
                        nonSelectedText: 'Please Select'
                    });
                    $('' + multiselect_id + '').empty();
                    $('' + multiselect_id + '').multiselect('dataprovider', multiselect_data);

                    // if no subcategories found . . .
                    if (status == 0) {
                        $("" + multiselect_id + " option[value='" + item_sub_category_id + "']").prop("selected", true);
                    }

                    // refresh multiselect
                    $('' + multiselect_id + '').multiselect("refresh");
                },
                error: function (xhr, status, error) {
                    console.log(error);
                }

            });
        }

        function AddRow() {

            var BireferralData = new Array();
            var BIREFERRAL_DOMAIN = $("#BIREFERRAL_DOMAIN").val();
            var BIREFERRAL_SERVICES = $("select[name=BIREFERRAL_SERVICES]:selected").val();
            var REFERRAL_DATE = $("#refferalDate").val();
            var csrftoken = $.cookie('csrftoken');
            var values = {
                'csrfmiddlewaretoken': csrftoken
            };

            console.clear()
            console.log([{BireferralData}, {BIREFERRAL_DOMAIN}, {BIREFERRAL_SERVICES}, {REFERRAL_DATE}, {csrftoken}])

          

        }

        function RemoveRow(index, uuid, tr_id) {
            if (index == 1) {
                // Delete Table Row
                $("#" + tr_id).remove();

                var OlmisAssessmentData = new Array();
                $('#assessment_manager_table tr').each(function (row, tr) {
                    var olmis_assessment_domain = $(tr).find('input[id="holmis_assessment_domain"]').val();
                    var olmis_assessment_coreservice = $(tr).find('input[id="holmis_assessment_coreservice"]').val();
                    var olmis_assessment_coreservice_status = $(tr).find('input[id="holmis_assessment_coreservice_status"]').val();

                    OlmisAssessmentData[row] = {
                        "olmis_assessment_domain": olmis_assessment_domain,
                        "olmis_assessment_coreservice": olmis_assessment_coreservice,
                        "olmis_assessment_coreservice_status": olmis_assessment_coreservice_status
                    }

                });

                OlmisAssessmentData.shift(); //remove first row(headers stuff)
                OlmisAssessmentData.shift(); //remove second row(controls stuff)
                OlmisAssessmentData = JSON.stringify(OlmisAssessmentData);

                // Set olmis_assessment_provided_list
                $('#olmis_assessment_provided_list').val(OlmisAssessmentData);
            }

            if (index == 2) {
                // Delete Table Row
                $("#" + tr_id).remove();

                var OlmisServiceData = new Array();
                $('#services_manager_table tr').each(function (row, tr) {
                    var olmis_domain = $(tr).find('input[id="holmis_domain"]').val();
                    var olmis_service = $(tr).find('input[id="holmis_service"]').val();
                    var olmis_service_date = $(tr).find('td:eq(3)').text();
                    var olmis_service_status = $(tr).find('input[id="holmis_service_status"]').val();

                    OlmisServiceData[row] = {
                        "olmis_domain": olmis_domain,
                        "olmis_service": olmis_service,
                        "olmis_service_date": olmis_service_date,
                        "olmis_service_status": olmis_service_status
                    }

                });

                OlmisServiceData.shift(); //remove first row(headers stuff)
                OlmisServiceData.shift(); //remove second row(controls stuff)
                OlmisServiceData = JSON.stringify(OlmisServiceData);

                // Set service_provided_list
                $('#olmis_service_provided_list').val(OlmisServiceData);
            }

            if (index == 3) {
                // $('#priority_manager_table').find("tr:gt(1)").remove();
                // $("#btnClearGrid").css({ 'display': "none" });

                // Delete Table Row
                $("#" + tr_id).remove();

                var OlmisPriorityServiceData = new Array();
                $('#priority_manager_table tr').each(function (row, tr) {
                    var olmis_priority_domain = $(tr).find('input[id="holmis_priority_domain"]').val();
                    var olmis_priority_service = $(tr).find('input[id="holmis_priority_service"]').val();

                    OlmisPriorityServiceData[row] = {
                        "olmis_priority_domain": olmis_priority_domain,
                        "olmis_priority_service": olmis_priority_service
                    }

                });

                OlmisPriorityServiceData.shift(); //remove first row(headers stuff)
                OlmisPriorityServiceData.shift(); //remove second row(controls stuff)
                OlmisPriorityServiceData = JSON.stringify(OlmisPriorityServiceData);

                // Set olmis_priority_service_provided_list
                $('#olmis_priority_service_provided_list').val(OlmisPriorityServiceData);
            }
        }

        function displayVals(x, value) {
            var selections = [];
            var hselections = [];
            if (x == 1) {
                $("#" + value + " option:selected").each(function () {
                    var $this = $(this);
                    if ($this.length) {
                        var selText = $this.text();
                        selections.push(selText);
                    }
                });
                $("#sel_" + value).html(selections.join(", "));
            }
            if (x == 2) {
                $("#" + value + " option:selected").each(function () {
                    var $this = $(this);
                    if ($this.length) {
                        var selText = $this.text();
                        selections.push(selText);
                        //console.log(selText);
                    }
                });

                return selections.join(", <br>");
            }
            if (x == 3) {
                $("#" + value + " option:selected").each(function () {
                    var $this = $(this);
                    if ($this.length) {
                        var selValue = $this.val();
                        hselections.push(selValue);
                    }
                });

                var selections = hselections.join(", ");

                $("#holmis_assessment_coreservice_status").val(selections);
            }
        }

        $("#olmis_assessment_domain").change(function (event) {
            var olmis_assessment_domain = $("#olmis_assessment_domain").val();

            $("#olmis_assessment_domain_errormsg").css({'display': "none"});

            $('#olmis_assessment_coreservice').multiselect("clearSelection");
            $('#olmis_assessment_coreservice').multiselect("refresh");
            $('#olmis_assessment_coreservice').trigger("change");
            $("#olmis_assessment_coreservice_errormsg").css({'display': "none"});
            getServices(1, olmis_assessment_domain);
        });

        $("#olmis_assessment_coreservice").change(function (event) {
            var olmis_assessment_coreservice = $("#olmis_assessment_coreservice").val();
            getServices(2, olmis_assessment_coreservice);

            $('#olmis_assessment_coreservice_status').multiselect("clearSelection");
            $('#olmis_assessment_coreservice_status').multiselect('refresh');
            $("#olmis_assessment_coreservice_status_errormsg").css({'display': "none"});
            $('#sel_olmis_assessment_coreservice_status').html('');
        });

        $("#olmis_assessment_coreservice_status").change(function (event) {
            var olmis_assessment_coreservice = $("#olmis_assessment_coreservice").val();
            displayVals(1, 'olmis_assessment_coreservice_status');
            $("#olmis_assessment_coreservice_status_errormsg").css({'display': "none"});
        });

        $("#olmis_domain").change(function (event) {
            var olmis_domain = $("#olmis_domain").val();
            getServices(3, olmis_domain);
            $("#olmis_domain_errormsg").css({'display': "none"});
        });

        $("#olmis_priority_domain").change(function (event) {
            var olmis_priority_domain = $("#olmis_priority_domain").val();

            getServices(5, olmis_priority_domain);
            $("#olmis_priority_domain_errormsg").css({'display': "none"});
            $("#sel_olmis_priority_service").html('');

        });

        // -----------------------------------------------------------------------------------------

        $("#olmis_service").change(function (event) {
            $("#olmis_service_errormsg").css({'display': "none"});
        });

        $("#olmis_service_date").change(function (event) {
            $("#olmis_service_date_errormsg").css({'display': "none"});
        });

        $("#olmis_service_provider").change(function (event) {
            $("#olmis_service_provider_errormsg").css({'display': "none"});
        });

        $("#olmis_place_of_service").change(function (event) {
            $("#olmis_place_of_service_errormsg").css({'display': "none"});
        });

        // -----------------------------------------------------------------------------------------

        $("#olmis_priority_health").change(function (event) {
            displayVals(1, 'olmis_priority_health');
        });

        $("#olmis_priority_shelter").change(function (event) {
            displayVals(1, 'olmis_priority_shelter');
        });

        $("#olmis_priority_protection").change(function (event) {
            displayVals(1, 'olmis_priority_protection');
        });

        $("#olmis_priority_pss").change(function (event) {
            displayVals(1, 'olmis_priority_pss');
        });

        $("#olmis_priority_education").change(function (event) {
            displayVals(1, 'olmis_priority_education');
        });

        $("#olmis_priority_hes").change(function (event) {
            displayVals(1, 'olmis_priority_hes');
        });

        $("#olmis_critical_event").change(function (event) {
            displayVals(1, 'olmis_critical_event');
        });
    </script>
{% endblock %}